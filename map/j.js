async function main(){const l=await fetch("https://data.busrouter.sg/v1/routes.geojson").then(s=>s.json()),a=await fetch("https://data.busrouter.sg/v1/services.json").then(s=>s.json()),e=await fetch("https://data.busrouter.sg/v1/stops.geojson").then(s=>s.json()),d=Math.floor(Math.random()*e.features.length),m=Math.floor(Math.random()*e.features.length),o={number:e.features[d].id,location:e.features[d].geometry.coordinates,name:e.features[d].properties.name,services:e.features[d].properties.services},n={number:e.features[m].id,location:e.features[m].geometry.coordinates,name:e.features[m].properties.name,services:e.features[m].properties.services};o.services.some(s=>n.services.includes(s))&&location.reload();const r=L.map("map").setView([1.3521,103.8198],12);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(r);const h=L.circleMarker([o.location[1],o.location[0]],{color:"red"}).addTo(r),v=L.circleMarker([n.location[1],n.location[0]],{color:"red"}).addTo(r);h.bindPopup(`
    <div>${o.name}<br>${showbuses(o.services)}</div>
  `),v.bindPopup(`
    <div>${n.name}<br>${showbuses(n.services)}</div>
  `);let y,g=[h,v];h.on("popupopen",u),v.on("popupopen",u);function u(){document.querySelectorAll("button").forEach(t=>{let f;const c=`hsl(${Math.random()*360},100%,50%)`;t.addEventListener("mouseover",()=>{y=L.geoJSON(k(t.textContent),{style:{color:c}}).addTo(r),f=!1}),t.addEventListener("mouseout",()=>{f||r.removeLayer(y)}),t.addEventListener("click",()=>{f=!0,(a[t.textContent].routes[1]?a[t.textContent].routes[0].concat(a[t.textContent].routes[1]):a[t.textContent].routes[0]).forEach(p=>{if(p!=o.number&&p!=n.number){const b={name:e.features.filter(i=>i.id==p)[0].properties.name,services:e.features.filter(i=>i.id==p)[0].properties.services,location:e.features.filter(i=>i.id==p)[0].geometry.coordinates},S=L.circleMarker([b.location[1],b.location[0]],{color:c}).addTo(r);S.bindPopup(`
              <div>${b.name}<br>${showbuses(b.services)}</div>
            `),S.on("popupopen",u),S.on("popupopen",i=>{g.push(i.target),r.eachLayer(x=>{x instanceof L.CircleMarker&&!g.includes(x)&&r.removeLayer(x),x!=i.target&&x.unbindPopup()});const w=y.toGeoJSON().features[0].geometry.coordinates,O=[i.target.getLatLng().lng,i.target.getLatLng().lat],F=closestPointOnLine(w.flat(),O),P=closestPointOnLine(w.flat(),o.location),$=w[P.segmentIndex];console.log($)})}}),r.closePopup()})})}function k(s){const t=l.features.filter(c=>c.properties.number==s);return t.length==0?void 0:{type:"Feature",geometry:{type:"MultiLineString",coordinates:t.map(c=>c.geometry.coordinates)},properties:{}}}}function showbuses(l){let a="";return l.forEach(e=>{a+=`<button>${e}</button>`}),a}function closestPointOnLine(l,a){let e,d=1/0,m=-1;for(let o=0;o<l.length-1;o++){const[n,M]=l[o],[r,h]=l[o+1],[v,y]=a,g=r-n,u=h-M,k=v-n,s=y-M;let t=(k*g+s*u)/(g*g+u*u);t<0?t=0:t>1&&(t=1);const f=n+t*g,c=M+t*u,C=v-f,p=y-c,b=Math.sqrt(C*C+p*p);b<d&&(d=b,e=[f,c],m=o)}return{point:e,segmentIndex:m}}main();
